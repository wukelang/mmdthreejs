{
  "version": 3,
  "sources": ["../../three/examples/jsm/animation/CCDIKSolver.js", "../../three/examples/jsm/animation/MMDPhysics.js", "../../three/examples/jsm/animation/MMDAnimationHelper.js"],
  "sourcesContent": ["import {\n\tBufferAttribute,\n\tBufferGeometry,\n\tColor,\n\tLine,\n\tLineBasicMaterial,\n\tMatrix4,\n\tMesh,\n\tMeshBasicMaterial,\n\tObject3D,\n\tQuaternion,\n\tSphereGeometry,\n\tVector3\n} from 'three';\n\nconst _q = new Quaternion();\nconst _targetPos = new Vector3();\nconst _targetVec = new Vector3();\nconst _effectorPos = new Vector3();\nconst _effectorVec = new Vector3();\nconst _linkPos = new Vector3();\nconst _invLinkQ = new Quaternion();\nconst _linkScale = new Vector3();\nconst _axis = new Vector3();\nconst _vector = new Vector3();\nconst _matrix = new Matrix4();\n\n\n/**\n * CCD Algorithm\n *  - https://sites.google.com/site/auraliusproject/ccd-algorithm\n *\n * // ik parameter example\n * //\n * // target, effector, index in links are bone index in skeleton.bones.\n * // the bones relation should be\n * // <-- parent                                  child -->\n * // links[ n ], links[ n - 1 ], ..., links[ 0 ], effector\n * iks = [ {\n *\ttarget: 1,\n *\teffector: 2,\n *\tlinks: [ { index: 5, limitation: new Vector3( 1, 0, 0 ) }, { index: 4, enabled: false }, { index : 3 } ],\n *\titeration: 10,\n *\tminAngle: 0.0,\n *\tmaxAngle: 1.0,\n * } ];\n */\n\nclass CCDIKSolver {\n\n\t/**\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @param {Array<Object>} iks\n\t */\n\tconstructor( mesh, iks = [] ) {\n\n\t\tthis.mesh = mesh;\n\t\tthis.iks = iks;\n\n\t\tthis._valid();\n\n\t}\n\n\t/**\n\t * Update all IK bones.\n\t *\n\t * @return {CCDIKSolver}\n\t */\n\tupdate() {\n\n\t\tconst iks = this.iks;\n\n\t\tfor ( let i = 0, il = iks.length; i < il; i ++ ) {\n\n\t\t\tthis.updateOne( iks[ i ] );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Update one IK bone\n\t *\n\t * @param {Object} ik parameter\n\t * @return {CCDIKSolver}\n\t */\n\tupdateOne( ik ) {\n\n\t\tconst bones = this.mesh.skeleton.bones;\n\n\t\t// for reference overhead reduction in loop\n\t\tconst math = Math;\n\n\t\tconst effector = bones[ ik.effector ];\n\t\tconst target = bones[ ik.target ];\n\n\t\t// don't use getWorldPosition() here for the performance\n\t\t// because it calls updateMatrixWorld( true ) inside.\n\t\t_targetPos.setFromMatrixPosition( target.matrixWorld );\n\n\t\tconst links = ik.links;\n\t\tconst iteration = ik.iteration !== undefined ? ik.iteration : 1;\n\n\t\tfor ( let i = 0; i < iteration; i ++ ) {\n\n\t\t\tlet rotated = false;\n\n\t\t\tfor ( let j = 0, jl = links.length; j < jl; j ++ ) {\n\n\t\t\t\tconst link = bones[ links[ j ].index ];\n\n\t\t\t\t// skip this link and following links.\n\t\t\t\t// this skip is used for MMD performance optimization.\n\t\t\t\tif ( links[ j ].enabled === false ) break;\n\n\t\t\t\tconst limitation = links[ j ].limitation;\n\t\t\t\tconst rotationMin = links[ j ].rotationMin;\n\t\t\t\tconst rotationMax = links[ j ].rotationMax;\n\n\t\t\t\t// don't use getWorldPosition/Quaternion() here for the performance\n\t\t\t\t// because they call updateMatrixWorld( true ) inside.\n\t\t\t\tlink.matrixWorld.decompose( _linkPos, _invLinkQ, _linkScale );\n\t\t\t\t_invLinkQ.invert();\n\t\t\t\t_effectorPos.setFromMatrixPosition( effector.matrixWorld );\n\n\t\t\t\t// work in link world\n\t\t\t\t_effectorVec.subVectors( _effectorPos, _linkPos );\n\t\t\t\t_effectorVec.applyQuaternion( _invLinkQ );\n\t\t\t\t_effectorVec.normalize();\n\n\t\t\t\t_targetVec.subVectors( _targetPos, _linkPos );\n\t\t\t\t_targetVec.applyQuaternion( _invLinkQ );\n\t\t\t\t_targetVec.normalize();\n\n\t\t\t\tlet angle = _targetVec.dot( _effectorVec );\n\n\t\t\t\tif ( angle > 1.0 ) {\n\n\t\t\t\t\tangle = 1.0;\n\n\t\t\t\t} else if ( angle < - 1.0 ) {\n\n\t\t\t\t\tangle = - 1.0;\n\n\t\t\t\t}\n\n\t\t\t\tangle = math.acos( angle );\n\n\t\t\t\t// skip if changing angle is too small to prevent vibration of bone\n\t\t\t\tif ( angle < 1e-5 ) continue;\n\n\t\t\t\tif ( ik.minAngle !== undefined && angle < ik.minAngle ) {\n\n\t\t\t\t\tangle = ik.minAngle;\n\n\t\t\t\t}\n\n\t\t\t\tif ( ik.maxAngle !== undefined && angle > ik.maxAngle ) {\n\n\t\t\t\t\tangle = ik.maxAngle;\n\n\t\t\t\t}\n\n\t\t\t\t_axis.crossVectors( _effectorVec, _targetVec );\n\t\t\t\t_axis.normalize();\n\n\t\t\t\t_q.setFromAxisAngle( _axis, angle );\n\t\t\t\tlink.quaternion.multiply( _q );\n\n\t\t\t\t// TODO: re-consider the limitation specification\n\t\t\t\tif ( limitation !== undefined ) {\n\n\t\t\t\t\tlet c = link.quaternion.w;\n\n\t\t\t\t\tif ( c > 1.0 ) c = 1.0;\n\n\t\t\t\t\tconst c2 = math.sqrt( 1 - c * c );\n\t\t\t\t\tlink.quaternion.set( limitation.x * c2,\n\t\t\t\t\t                     limitation.y * c2,\n\t\t\t\t\t                     limitation.z * c2,\n\t\t\t\t\t                     c );\n\n\t\t\t\t}\n\n\t\t\t\tif ( rotationMin !== undefined ) {\n\n\t\t\t\t\tlink.rotation.setFromVector3( _vector.setFromEuler( link.rotation ).max( rotationMin ) );\n\n\t\t\t\t}\n\n\t\t\t\tif ( rotationMax !== undefined ) {\n\n\t\t\t\t\tlink.rotation.setFromVector3( _vector.setFromEuler( link.rotation ).min( rotationMax ) );\n\n\t\t\t\t}\n\n\t\t\t\tlink.updateMatrixWorld( true );\n\n\t\t\t\trotated = true;\n\n\t\t\t}\n\n\t\t\tif ( ! rotated ) break;\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Creates Helper\n\t *\n\t * @return {CCDIKHelper}\n\t */\n\tcreateHelper() {\n\n\t\treturn new CCDIKHelper( this.mesh, this.iks );\n\n\t}\n\n\t// private methods\n\n\t_valid() {\n\n\t\tconst iks = this.iks;\n\t\tconst bones = this.mesh.skeleton.bones;\n\n\t\tfor ( let i = 0, il = iks.length; i < il; i ++ ) {\n\n\t\t\tconst ik = iks[ i ];\n\t\t\tconst effector = bones[ ik.effector ];\n\t\t\tconst links = ik.links;\n\t\t\tlet link0, link1;\n\n\t\t\tlink0 = effector;\n\n\t\t\tfor ( let j = 0, jl = links.length; j < jl; j ++ ) {\n\n\t\t\t\tlink1 = bones[ links[ j ].index ];\n\n\t\t\t\tif ( link0.parent !== link1 ) {\n\n\t\t\t\t\tconsole.warn( 'THREE.CCDIKSolver: bone ' + link0.name + ' is not the child of bone ' + link1.name );\n\n\t\t\t\t}\n\n\t\t\t\tlink0 = link1;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\nfunction getPosition( bone, matrixWorldInv ) {\n\n\treturn _vector\n\t\t.setFromMatrixPosition( bone.matrixWorld )\n\t\t.applyMatrix4( matrixWorldInv );\n\n}\n\nfunction setPositionOfBoneToAttributeArray( array, index, bone, matrixWorldInv ) {\n\n\tconst v = getPosition( bone, matrixWorldInv );\n\n\tarray[ index * 3 + 0 ] = v.x;\n\tarray[ index * 3 + 1 ] = v.y;\n\tarray[ index * 3 + 2 ] = v.z;\n\n}\n\n/**\n * Visualize IK bones\n *\n * @param {SkinnedMesh} mesh\n * @param {Array<Object>} iks\n */\nclass CCDIKHelper extends Object3D {\n\n\tconstructor( mesh, iks = [], sphereSize = 0.25 ) {\n\n\t\tsuper();\n\n\t\tthis.root = mesh;\n\t\tthis.iks = iks;\n\n\t\tthis.matrix.copy( mesh.matrixWorld );\n\t\tthis.matrixAutoUpdate = false;\n\n\t\tthis.sphereGeometry = new SphereGeometry( sphereSize, 16, 8 );\n\n\t\tthis.targetSphereMaterial = new MeshBasicMaterial( {\n\t\t\tcolor: new Color( 0xff8888 ),\n\t\t\tdepthTest: false,\n\t\t\tdepthWrite: false,\n\t\t\ttransparent: true\n\t\t} );\n\n\t\tthis.effectorSphereMaterial = new MeshBasicMaterial( {\n\t\t\tcolor: new Color( 0x88ff88 ),\n\t\t\tdepthTest: false,\n\t\t\tdepthWrite: false,\n\t\t\ttransparent: true\n\t\t} );\n\n\t\tthis.linkSphereMaterial = new MeshBasicMaterial( {\n\t\t\tcolor: new Color( 0x8888ff ),\n\t\t\tdepthTest: false,\n\t\t\tdepthWrite: false,\n\t\t\ttransparent: true\n\t\t} );\n\n\t\tthis.lineMaterial = new LineBasicMaterial( {\n\t\t\tcolor: new Color( 0xff0000 ),\n\t\t\tdepthTest: false,\n\t\t\tdepthWrite: false,\n\t\t\ttransparent: true\n\t\t} );\n\n\t\tthis._init();\n\n\t}\n\n\t/**\n\t * Updates IK bones visualization.\n\t */\n\tupdateMatrixWorld( force ) {\n\n\t\tconst mesh = this.root;\n\n\t\tif ( this.visible ) {\n\n\t\t\tlet offset = 0;\n\n\t\t\tconst iks = this.iks;\n\t\t\tconst bones = mesh.skeleton.bones;\n\n\t\t\t_matrix.copy( mesh.matrixWorld ).invert();\n\n\t\t\tfor ( let i = 0, il = iks.length; i < il; i ++ ) {\n\n\t\t\t\tconst ik = iks[ i ];\n\n\t\t\t\tconst targetBone = bones[ ik.target ];\n\t\t\t\tconst effectorBone = bones[ ik.effector ];\n\n\t\t\t\tconst targetMesh = this.children[ offset ++ ];\n\t\t\t\tconst effectorMesh = this.children[ offset ++ ];\n\n\t\t\t\ttargetMesh.position.copy( getPosition( targetBone, _matrix ) );\n\t\t\t\teffectorMesh.position.copy( getPosition( effectorBone, _matrix ) );\n\n\t\t\t\tfor ( let j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst link = ik.links[ j ];\n\t\t\t\t\tconst linkBone = bones[ link.index ];\n\n\t\t\t\t\tconst linkMesh = this.children[ offset ++ ];\n\n\t\t\t\t\tlinkMesh.position.copy( getPosition( linkBone, _matrix ) );\n\n\t\t\t\t}\n\n\t\t\t\tconst line = this.children[ offset ++ ];\n\t\t\t\tconst array = line.geometry.attributes.position.array;\n\n\t\t\t\tsetPositionOfBoneToAttributeArray( array, 0, targetBone, _matrix );\n\t\t\t\tsetPositionOfBoneToAttributeArray( array, 1, effectorBone, _matrix );\n\n\t\t\t\tfor ( let j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst link = ik.links[ j ];\n\t\t\t\t\tconst linkBone = bones[ link.index ];\n\t\t\t\t\tsetPositionOfBoneToAttributeArray( array, j + 2, linkBone, _matrix );\n\n\t\t\t\t}\n\n\t\t\t\tline.geometry.attributes.position.needsUpdate = true;\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.matrix.copy( mesh.matrixWorld );\n\n\t\tsuper.updateMatrixWorld( force );\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this method whenever this instance is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tthis.sphereGeometry.dispose();\n\n\t\tthis.targetSphereMaterial.dispose();\n\t\tthis.effectorSphereMaterial.dispose();\n\t\tthis.linkSphereMaterial.dispose();\n\t\tthis.lineMaterial.dispose();\n\n\t\tconst children = this.children;\n\n\t\tfor ( let i = 0; i < children.length; i ++ ) {\n\n\t\t\tconst child = children[ i ];\n\n\t\t\tif ( child.isLine ) child.geometry.dispose();\n\n\t\t}\n\n\t}\n\n\t// private method\n\n\t_init() {\n\n\t\tconst scope = this;\n\t\tconst iks = this.iks;\n\n\t\tfunction createLineGeometry( ik ) {\n\n\t\t\tconst geometry = new BufferGeometry();\n\t\t\tconst vertices = new Float32Array( ( 2 + ik.links.length ) * 3 );\n\t\t\tgeometry.setAttribute( 'position', new BufferAttribute( vertices, 3 ) );\n\n\t\t\treturn geometry;\n\n\t\t}\n\n\t\tfunction createTargetMesh() {\n\n\t\t\treturn new Mesh( scope.sphereGeometry, scope.targetSphereMaterial );\n\n\t\t}\n\n\t\tfunction createEffectorMesh() {\n\n\t\t\treturn new Mesh( scope.sphereGeometry, scope.effectorSphereMaterial );\n\n\t\t}\n\n\t\tfunction createLinkMesh() {\n\n\t\t\treturn new Mesh( scope.sphereGeometry, scope.linkSphereMaterial );\n\n\t\t}\n\n\t\tfunction createLine( ik ) {\n\n\t\t\treturn new Line( createLineGeometry( ik ), scope.lineMaterial );\n\n\t\t}\n\n\t\tfor ( let i = 0, il = iks.length; i < il; i ++ ) {\n\n\t\t\tconst ik = iks[ i ];\n\n\t\t\tthis.add( createTargetMesh() );\n\t\t\tthis.add( createEffectorMesh() );\n\n\t\t\tfor ( let j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\tthis.add( createLinkMesh() );\n\n\t\t\t}\n\n\t\t\tthis.add( createLine( ik ) );\n\n\t\t}\n\n\t}\n\n}\n\nexport { CCDIKSolver, CCDIKHelper };\n", "import {\n\tBone,\n\tBoxGeometry,\n\tCapsuleGeometry,\n\tColor,\n\tEuler,\n\tMatrix4,\n\tMesh,\n\tMeshBasicMaterial,\n\tObject3D,\n\tQuaternion,\n\tSphereGeometry,\n\tVector3\n} from 'three';\n\n/**\n * Dependencies\n *  - Ammo.js https://github.com/kripken/ammo.js\n *\n * MMDPhysics calculates physics with Ammo(Bullet based JavaScript Physics engine)\n * for MMD model loaded by MMDLoader.\n *\n * TODO\n *  - Physics in Worker\n */\n\n/* global Ammo */\n\nclass MMDPhysics {\n\n\t/**\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @param {Array<Object>} rigidBodyParams\n\t * @param {Array<Object>} (optional) constraintParams\n\t * @param {Object} params - (optional)\n\t * @param {Number} params.unitStep - Default is 1 / 65.\n\t * @param {Integer} params.maxStepNum - Default is 3.\n\t * @param {Vector3} params.gravity - Default is ( 0, - 9.8 * 10, 0 )\n\t */\n\tconstructor( mesh, rigidBodyParams, constraintParams = [], params = {} ) {\n\n\t\tif ( typeof Ammo === 'undefined' ) {\n\n\t\t\tthrow new Error( 'THREE.MMDPhysics: Import ammo.js https://github.com/kripken/ammo.js' );\n\n\t\t}\n\n\t\tthis.manager = new ResourceManager();\n\n\t\tthis.mesh = mesh;\n\n\t\t/*\n\t\t * I don't know why but 1/60 unitStep easily breaks models\n\t\t * so I set it 1/65 so far.\n\t\t * Don't set too small unitStep because\n\t\t * the smaller unitStep can make the performance worse.\n\t\t */\n\t\tthis.unitStep = ( params.unitStep !== undefined ) ? params.unitStep : 1 / 65;\n\t\tthis.maxStepNum = ( params.maxStepNum !== undefined ) ? params.maxStepNum : 3;\n\t\tthis.gravity = new Vector3( 0, - 9.8 * 10, 0 );\n\n\t\tif ( params.gravity !== undefined ) this.gravity.copy( params.gravity );\n\n\t\tthis.world = params.world !== undefined ? params.world : null; // experimental\n\n\t\tthis.bodies = [];\n\t\tthis.constraints = [];\n\n\t\tthis._init( mesh, rigidBodyParams, constraintParams );\n\n\t}\n\n\t/**\n\t * Advances Physics calculation and updates bones.\n\t *\n\t * @param {Number} delta - time in second\n\t * @return {MMDPhysics}\n\t */\n\tupdate( delta ) {\n\n\t\tconst manager = this.manager;\n\t\tconst mesh = this.mesh;\n\n\t\t// rigid bodies and constrains are for\n\t\t// mesh's world scale (1, 1, 1).\n\t\t// Convert to (1, 1, 1) if it isn't.\n\n\t\tlet isNonDefaultScale = false;\n\n\t\tconst position = manager.allocThreeVector3();\n\t\tconst quaternion = manager.allocThreeQuaternion();\n\t\tconst scale = manager.allocThreeVector3();\n\n\t\tmesh.matrixWorld.decompose( position, quaternion, scale );\n\n\t\tif ( scale.x !== 1 || scale.y !== 1 || scale.z !== 1 ) {\n\n\t\t\tisNonDefaultScale = true;\n\n\t\t}\n\n\t\tlet parent;\n\n\t\tif ( isNonDefaultScale ) {\n\n\t\t\tparent = mesh.parent;\n\n\t\t\tif ( parent !== null ) mesh.parent = null;\n\n\t\t\tscale.copy( this.mesh.scale );\n\n\t\t\tmesh.scale.set( 1, 1, 1 );\n\t\t\tmesh.updateMatrixWorld( true );\n\n\t\t}\n\n\t\t// calculate physics and update bones\n\n\t\tthis._updateRigidBodies();\n\t\tthis._stepSimulation( delta );\n\t\tthis._updateBones();\n\n\t\t// restore mesh if converted above\n\n\t\tif ( isNonDefaultScale ) {\n\n\t\t\tif ( parent !== null ) mesh.parent = parent;\n\n\t\t\tmesh.scale.copy( scale );\n\n\t\t}\n\n\t\tmanager.freeThreeVector3( scale );\n\t\tmanager.freeThreeQuaternion( quaternion );\n\t\tmanager.freeThreeVector3( position );\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Resets rigid bodies transorm to current bone's.\n\t *\n\t * @return {MMDPhysics}\n\t */\n\treset() {\n\n\t\tfor ( let i = 0, il = this.bodies.length; i < il; i ++ ) {\n\n\t\t\tthis.bodies[ i ].reset();\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Warm ups Rigid bodies. Calculates cycles steps.\n\t *\n\t * @param {Integer} cycles\n\t * @return {MMDPhysics}\n\t */\n\twarmup( cycles ) {\n\n\t\tfor ( let i = 0; i < cycles; i ++ ) {\n\n\t\t\tthis.update( 1 / 60 );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Sets gravity.\n\t *\n\t * @param {Vector3} gravity\n\t * @return {MMDPhysicsHelper}\n\t */\n\tsetGravity( gravity ) {\n\n\t\tthis.world.setGravity( new Ammo.btVector3( gravity.x, gravity.y, gravity.z ) );\n\t\tthis.gravity.copy( gravity );\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Creates MMDPhysicsHelper\n\t *\n\t * @return {MMDPhysicsHelper}\n\t */\n\tcreateHelper() {\n\n\t\treturn new MMDPhysicsHelper( this.mesh, this );\n\n\t}\n\n\t// private methods\n\n\t_init( mesh, rigidBodyParams, constraintParams ) {\n\n\t\tconst manager = this.manager;\n\n\t\t// rigid body/constraint parameters are for\n\t\t// mesh's default world transform as position(0, 0, 0),\n\t\t// quaternion(0, 0, 0, 1) and scale(0, 0, 0)\n\n\t\tconst parent = mesh.parent;\n\n\t\tif ( parent !== null ) mesh.parent = null;\n\n\t\tconst currentPosition = manager.allocThreeVector3();\n\t\tconst currentQuaternion = manager.allocThreeQuaternion();\n\t\tconst currentScale = manager.allocThreeVector3();\n\n\t\tcurrentPosition.copy( mesh.position );\n\t\tcurrentQuaternion.copy( mesh.quaternion );\n\t\tcurrentScale.copy( mesh.scale );\n\n\t\tmesh.position.set( 0, 0, 0 );\n\t\tmesh.quaternion.set( 0, 0, 0, 1 );\n\t\tmesh.scale.set( 1, 1, 1 );\n\n\t\tmesh.updateMatrixWorld( true );\n\n\t\tif ( this.world === null ) {\n\n\t\t\tthis.world = this._createWorld();\n\t\t\tthis.setGravity( this.gravity );\n\n\t\t}\n\n\t\tthis._initRigidBodies( rigidBodyParams );\n\t\tthis._initConstraints( constraintParams );\n\n\t\tif ( parent !== null ) mesh.parent = parent;\n\n\t\tmesh.position.copy( currentPosition );\n\t\tmesh.quaternion.copy( currentQuaternion );\n\t\tmesh.scale.copy( currentScale );\n\n\t\tmesh.updateMatrixWorld( true );\n\n\t\tthis.reset();\n\n\t\tmanager.freeThreeVector3( currentPosition );\n\t\tmanager.freeThreeQuaternion( currentQuaternion );\n\t\tmanager.freeThreeVector3( currentScale );\n\n\t}\n\n\t_createWorld() {\n\n\t\tconst config = new Ammo.btDefaultCollisionConfiguration();\n\t\tconst dispatcher = new Ammo.btCollisionDispatcher( config );\n\t\tconst cache = new Ammo.btDbvtBroadphase();\n\t\tconst solver = new Ammo.btSequentialImpulseConstraintSolver();\n\t\tconst world = new Ammo.btDiscreteDynamicsWorld( dispatcher, cache, solver, config );\n\t\treturn world;\n\n\t}\n\n\t_initRigidBodies( rigidBodies ) {\n\n\t\tfor ( let i = 0, il = rigidBodies.length; i < il; i ++ ) {\n\n\t\t\tthis.bodies.push( new RigidBody(\n\t\t\t\tthis.mesh, this.world, rigidBodies[ i ], this.manager ) );\n\n\t\t}\n\n\t}\n\n\t_initConstraints( constraints ) {\n\n\t\tfor ( let i = 0, il = constraints.length; i < il; i ++ ) {\n\n\t\t\tconst params = constraints[ i ];\n\t\t\tconst bodyA = this.bodies[ params.rigidBodyIndex1 ];\n\t\t\tconst bodyB = this.bodies[ params.rigidBodyIndex2 ];\n\t\t\tthis.constraints.push( new Constraint( this.mesh, this.world, bodyA, bodyB, params, this.manager ) );\n\n\t\t}\n\n\t}\n\n\t_stepSimulation( delta ) {\n\n\t\tconst unitStep = this.unitStep;\n\t\tlet stepTime = delta;\n\t\tlet maxStepNum = ( ( delta / unitStep ) | 0 ) + 1;\n\n\t\tif ( stepTime < unitStep ) {\n\n\t\t\tstepTime = unitStep;\n\t\t\tmaxStepNum = 1;\n\n\t\t}\n\n\t\tif ( maxStepNum > this.maxStepNum ) {\n\n\t\t\tmaxStepNum = this.maxStepNum;\n\n\t\t}\n\n\t\tthis.world.stepSimulation( stepTime, maxStepNum, unitStep );\n\n\t}\n\n\t_updateRigidBodies() {\n\n\t\tfor ( let i = 0, il = this.bodies.length; i < il; i ++ ) {\n\n\t\t\tthis.bodies[ i ].updateFromBone();\n\n\t\t}\n\n\t}\n\n\t_updateBones() {\n\n\t\tfor ( let i = 0, il = this.bodies.length; i < il; i ++ ) {\n\n\t\t\tthis.bodies[ i ].updateBone();\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * This manager's responsibilies are\n *\n * 1. manage Ammo.js and Three.js object resources and\n *    improve the performance and the memory consumption by\n *    reusing objects.\n *\n * 2. provide simple Ammo object operations.\n */\nclass ResourceManager {\n\n\tconstructor() {\n\n\t\t// for Three.js\n\t\tthis.threeVector3s = [];\n\t\tthis.threeMatrix4s = [];\n\t\tthis.threeQuaternions = [];\n\t\tthis.threeEulers = [];\n\n\t\t// for Ammo.js\n\t\tthis.transforms = [];\n\t\tthis.quaternions = [];\n\t\tthis.vector3s = [];\n\n\t}\n\n\tallocThreeVector3() {\n\n\t\treturn ( this.threeVector3s.length > 0 )\n\t\t\t? this.threeVector3s.pop()\n\t\t\t: new Vector3();\n\n\t}\n\n\tfreeThreeVector3( v ) {\n\n\t\tthis.threeVector3s.push( v );\n\n\t}\n\n\tallocThreeMatrix4() {\n\n\t\treturn ( this.threeMatrix4s.length > 0 )\n\t\t\t? this.threeMatrix4s.pop()\n\t\t\t: new Matrix4();\n\n\t}\n\n\tfreeThreeMatrix4( m ) {\n\n\t\tthis.threeMatrix4s.push( m );\n\n\t}\n\n\tallocThreeQuaternion() {\n\n\t\treturn ( this.threeQuaternions.length > 0 )\n\t\t\t? this.threeQuaternions.pop()\n\t\t\t: new Quaternion();\n\n\t}\n\n\tfreeThreeQuaternion( q ) {\n\n\t\tthis.threeQuaternions.push( q );\n\n\t}\n\n\tallocThreeEuler() {\n\n\t\treturn ( this.threeEulers.length > 0 )\n\t\t\t? this.threeEulers.pop()\n\t\t\t: new Euler();\n\n\t}\n\n\tfreeThreeEuler( e ) {\n\n\t\tthis.threeEulers.push( e );\n\n\t}\n\n\tallocTransform() {\n\n\t\treturn ( this.transforms.length > 0 )\n\t\t\t? this.transforms.pop()\n\t\t\t: new Ammo.btTransform();\n\n\t}\n\n\tfreeTransform( t ) {\n\n\t\tthis.transforms.push( t );\n\n\t}\n\n\tallocQuaternion() {\n\n\t\treturn ( this.quaternions.length > 0 )\n\t\t\t? this.quaternions.pop()\n\t\t\t: new Ammo.btQuaternion();\n\n\t}\n\n\tfreeQuaternion( q ) {\n\n\t\tthis.quaternions.push( q );\n\n\t}\n\n\tallocVector3() {\n\n\t\treturn ( this.vector3s.length > 0 )\n\t\t\t? this.vector3s.pop()\n\t\t\t: new Ammo.btVector3();\n\n\t}\n\n\tfreeVector3( v ) {\n\n\t\tthis.vector3s.push( v );\n\n\t}\n\n\tsetIdentity( t ) {\n\n\t\tt.setIdentity();\n\n\t}\n\n\tgetBasis( t ) {\n\n\t\tvar q = this.allocQuaternion();\n\t\tt.getBasis().getRotation( q );\n\t\treturn q;\n\n\t}\n\n\tgetBasisAsMatrix3( t ) {\n\n\t\tvar q = this.getBasis( t );\n\t\tvar m = this.quaternionToMatrix3( q );\n\t\tthis.freeQuaternion( q );\n\t\treturn m;\n\n\t}\n\n\tgetOrigin( t ) {\n\n\t\treturn t.getOrigin();\n\n\t}\n\n\tsetOrigin( t, v ) {\n\n\t\tt.getOrigin().setValue( v.x(), v.y(), v.z() );\n\n\t}\n\n\tcopyOrigin( t1, t2 ) {\n\n\t\tvar o = t2.getOrigin();\n\t\tthis.setOrigin( t1, o );\n\n\t}\n\n\tsetBasis( t, q ) {\n\n\t\tt.setRotation( q );\n\n\t}\n\n\tsetBasisFromMatrix3( t, m ) {\n\n\t\tvar q = this.matrix3ToQuaternion( m );\n\t\tthis.setBasis( t, q );\n\t\tthis.freeQuaternion( q );\n\n\t}\n\n\tsetOriginFromArray3( t, a ) {\n\n\t\tt.getOrigin().setValue( a[ 0 ], a[ 1 ], a[ 2 ] );\n\n\t}\n\n\tsetOriginFromThreeVector3( t, v ) {\n\n\t\tt.getOrigin().setValue( v.x, v.y, v.z );\n\n\t}\n\n\tsetBasisFromArray3( t, a ) {\n\n\t\tvar thQ = this.allocThreeQuaternion();\n\t\tvar thE = this.allocThreeEuler();\n\t\tthE.set( a[ 0 ], a[ 1 ], a[ 2 ] );\n\t\tthis.setBasisFromThreeQuaternion( t, thQ.setFromEuler( thE ) );\n\n\t\tthis.freeThreeEuler( thE );\n\t\tthis.freeThreeQuaternion( thQ );\n\n\t}\n\n\tsetBasisFromThreeQuaternion( t, a ) {\n\n\t\tvar q = this.allocQuaternion();\n\n\t\tq.setX( a.x );\n\t\tq.setY( a.y );\n\t\tq.setZ( a.z );\n\t\tq.setW( a.w );\n\t\tthis.setBasis( t, q );\n\n\t\tthis.freeQuaternion( q );\n\n\t}\n\n\tmultiplyTransforms( t1, t2 ) {\n\n\t\tvar t = this.allocTransform();\n\t\tthis.setIdentity( t );\n\n\t\tvar m1 = this.getBasisAsMatrix3( t1 );\n\t\tvar m2 = this.getBasisAsMatrix3( t2 );\n\n\t\tvar o1 = this.getOrigin( t1 );\n\t\tvar o2 = this.getOrigin( t2 );\n\n\t\tvar v1 = this.multiplyMatrix3ByVector3( m1, o2 );\n\t\tvar v2 = this.addVector3( v1, o1 );\n\t\tthis.setOrigin( t, v2 );\n\n\t\tvar m3 = this.multiplyMatrices3( m1, m2 );\n\t\tthis.setBasisFromMatrix3( t, m3 );\n\n\t\tthis.freeVector3( v1 );\n\t\tthis.freeVector3( v2 );\n\n\t\treturn t;\n\n\t}\n\n\tinverseTransform( t ) {\n\n\t\tvar t2 = this.allocTransform();\n\n\t\tvar m1 = this.getBasisAsMatrix3( t );\n\t\tvar o = this.getOrigin( t );\n\n\t\tvar m2 = this.transposeMatrix3( m1 );\n\t\tvar v1 = this.negativeVector3( o );\n\t\tvar v2 = this.multiplyMatrix3ByVector3( m2, v1 );\n\n\t\tthis.setOrigin( t2, v2 );\n\t\tthis.setBasisFromMatrix3( t2, m2 );\n\n\t\tthis.freeVector3( v1 );\n\t\tthis.freeVector3( v2 );\n\n\t\treturn t2;\n\n\t}\n\n\tmultiplyMatrices3( m1, m2 ) {\n\n\t\tvar m3 = [];\n\n\t\tvar v10 = this.rowOfMatrix3( m1, 0 );\n\t\tvar v11 = this.rowOfMatrix3( m1, 1 );\n\t\tvar v12 = this.rowOfMatrix3( m1, 2 );\n\n\t\tvar v20 = this.columnOfMatrix3( m2, 0 );\n\t\tvar v21 = this.columnOfMatrix3( m2, 1 );\n\t\tvar v22 = this.columnOfMatrix3( m2, 2 );\n\n\t\tm3[ 0 ] = this.dotVectors3( v10, v20 );\n\t\tm3[ 1 ] = this.dotVectors3( v10, v21 );\n\t\tm3[ 2 ] = this.dotVectors3( v10, v22 );\n\t\tm3[ 3 ] = this.dotVectors3( v11, v20 );\n\t\tm3[ 4 ] = this.dotVectors3( v11, v21 );\n\t\tm3[ 5 ] = this.dotVectors3( v11, v22 );\n\t\tm3[ 6 ] = this.dotVectors3( v12, v20 );\n\t\tm3[ 7 ] = this.dotVectors3( v12, v21 );\n\t\tm3[ 8 ] = this.dotVectors3( v12, v22 );\n\n\t\tthis.freeVector3( v10 );\n\t\tthis.freeVector3( v11 );\n\t\tthis.freeVector3( v12 );\n\t\tthis.freeVector3( v20 );\n\t\tthis.freeVector3( v21 );\n\t\tthis.freeVector3( v22 );\n\n\t\treturn m3;\n\n\t}\n\n\taddVector3( v1, v2 ) {\n\n\t\tvar v = this.allocVector3();\n\t\tv.setValue( v1.x() + v2.x(), v1.y() + v2.y(), v1.z() + v2.z() );\n\t\treturn v;\n\n\t}\n\n\tdotVectors3( v1, v2 ) {\n\n\t\treturn v1.x() * v2.x() + v1.y() * v2.y() + v1.z() * v2.z();\n\n\t}\n\n\trowOfMatrix3( m, i ) {\n\n\t\tvar v = this.allocVector3();\n\t\tv.setValue( m[ i * 3 + 0 ], m[ i * 3 + 1 ], m[ i * 3 + 2 ] );\n\t\treturn v;\n\n\t}\n\n\tcolumnOfMatrix3( m, i ) {\n\n\t\tvar v = this.allocVector3();\n\t\tv.setValue( m[ i + 0 ], m[ i + 3 ], m[ i + 6 ] );\n\t\treturn v;\n\n\t}\n\n\tnegativeVector3( v ) {\n\n\t\tvar v2 = this.allocVector3();\n\t\tv2.setValue( - v.x(), - v.y(), - v.z() );\n\t\treturn v2;\n\n\t}\n\n\tmultiplyMatrix3ByVector3( m, v ) {\n\n\t\tvar v4 = this.allocVector3();\n\n\t\tvar v0 = this.rowOfMatrix3( m, 0 );\n\t\tvar v1 = this.rowOfMatrix3( m, 1 );\n\t\tvar v2 = this.rowOfMatrix3( m, 2 );\n\t\tvar x = this.dotVectors3( v0, v );\n\t\tvar y = this.dotVectors3( v1, v );\n\t\tvar z = this.dotVectors3( v2, v );\n\n\t\tv4.setValue( x, y, z );\n\n\t\tthis.freeVector3( v0 );\n\t\tthis.freeVector3( v1 );\n\t\tthis.freeVector3( v2 );\n\n\t\treturn v4;\n\n\t}\n\n\ttransposeMatrix3( m ) {\n\n\t\tvar m2 = [];\n\t\tm2[ 0 ] = m[ 0 ];\n\t\tm2[ 1 ] = m[ 3 ];\n\t\tm2[ 2 ] = m[ 6 ];\n\t\tm2[ 3 ] = m[ 1 ];\n\t\tm2[ 4 ] = m[ 4 ];\n\t\tm2[ 5 ] = m[ 7 ];\n\t\tm2[ 6 ] = m[ 2 ];\n\t\tm2[ 7 ] = m[ 5 ];\n\t\tm2[ 8 ] = m[ 8 ];\n\t\treturn m2;\n\n\t}\n\n\tquaternionToMatrix3( q ) {\n\n\t\tvar m = [];\n\n\t\tvar x = q.x();\n\t\tvar y = q.y();\n\t\tvar z = q.z();\n\t\tvar w = q.w();\n\n\t\tvar xx = x * x;\n\t\tvar yy = y * y;\n\t\tvar zz = z * z;\n\n\t\tvar xy = x * y;\n\t\tvar yz = y * z;\n\t\tvar zx = z * x;\n\n\t\tvar xw = x * w;\n\t\tvar yw = y * w;\n\t\tvar zw = z * w;\n\n\t\tm[ 0 ] = 1 - 2 * ( yy + zz );\n\t\tm[ 1 ] = 2 * ( xy - zw );\n\t\tm[ 2 ] = 2 * ( zx + yw );\n\t\tm[ 3 ] = 2 * ( xy + zw );\n\t\tm[ 4 ] = 1 - 2 * ( zz + xx );\n\t\tm[ 5 ] = 2 * ( yz - xw );\n\t\tm[ 6 ] = 2 * ( zx - yw );\n\t\tm[ 7 ] = 2 * ( yz + xw );\n\t\tm[ 8 ] = 1 - 2 * ( xx + yy );\n\n\t\treturn m;\n\n\t}\n\n\tmatrix3ToQuaternion( m ) {\n\n\t\tvar t = m[ 0 ] + m[ 4 ] + m[ 8 ];\n\t\tvar s, x, y, z, w;\n\n\t\tif ( t > 0 ) {\n\n\t\t\ts = Math.sqrt( t + 1.0 ) * 2;\n\t\t\tw = 0.25 * s;\n\t\t\tx = ( m[ 7 ] - m[ 5 ] ) / s;\n\t\t\ty = ( m[ 2 ] - m[ 6 ] ) / s;\n\t\t\tz = ( m[ 3 ] - m[ 1 ] ) / s;\n\n\t\t} else if ( ( m[ 0 ] > m[ 4 ] ) && ( m[ 0 ] > m[ 8 ] ) ) {\n\n\t\t\ts = Math.sqrt( 1.0 + m[ 0 ] - m[ 4 ] - m[ 8 ] ) * 2;\n\t\t\tw = ( m[ 7 ] - m[ 5 ] ) / s;\n\t\t\tx = 0.25 * s;\n\t\t\ty = ( m[ 1 ] + m[ 3 ] ) / s;\n\t\t\tz = ( m[ 2 ] + m[ 6 ] ) / s;\n\n\t\t} else if ( m[ 4 ] > m[ 8 ] ) {\n\n\t\t\ts = Math.sqrt( 1.0 + m[ 4 ] - m[ 0 ] - m[ 8 ] ) * 2;\n\t\t\tw = ( m[ 2 ] - m[ 6 ] ) / s;\n\t\t\tx = ( m[ 1 ] + m[ 3 ] ) / s;\n\t\t\ty = 0.25 * s;\n\t\t\tz = ( m[ 5 ] + m[ 7 ] ) / s;\n\n\t\t} else {\n\n\t\t\ts = Math.sqrt( 1.0 + m[ 8 ] - m[ 0 ] - m[ 4 ] ) * 2;\n\t\t\tw = ( m[ 3 ] - m[ 1 ] ) / s;\n\t\t\tx = ( m[ 2 ] + m[ 6 ] ) / s;\n\t\t\ty = ( m[ 5 ] + m[ 7 ] ) / s;\n\t\t\tz = 0.25 * s;\n\n\t\t}\n\n\t\tvar q = this.allocQuaternion();\n\t\tq.setX( x );\n\t\tq.setY( y );\n\t\tq.setZ( z );\n\t\tq.setW( w );\n\t\treturn q;\n\n\t}\n\n}\n\n/**\n * @param {THREE.SkinnedMesh} mesh\n * @param {Ammo.btDiscreteDynamicsWorld} world\n * @param {Object} params\n * @param {ResourceManager} manager\n */\nclass RigidBody {\n\n\tconstructor( mesh, world, params, manager ) {\n\n\t\tthis.mesh = mesh;\n\t\tthis.world = world;\n\t\tthis.params = params;\n\t\tthis.manager = manager;\n\n\t\tthis.body = null;\n\t\tthis.bone = null;\n\t\tthis.boneOffsetForm = null;\n\t\tthis.boneOffsetFormInverse = null;\n\n\t\tthis._init();\n\n\t}\n\n\t/**\n\t * Resets rigid body transform to the current bone's.\n\t *\n\t * @return {RigidBody}\n\t */\n\treset() {\n\n\t\tthis._setTransformFromBone();\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Updates rigid body's transform from the current bone.\n\t *\n\t * @return {RidigBody}\n\t */\n\tupdateFromBone() {\n\n\t\tif ( this.params.boneIndex !== - 1 && this.params.type === 0 ) {\n\n\t\t\tthis._setTransformFromBone();\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Updates bone from the current ridid body's transform.\n\t *\n\t * @return {RidigBody}\n\t */\n\tupdateBone() {\n\n\t\tif ( this.params.type === 0 || this.params.boneIndex === - 1 ) {\n\n\t\t\treturn this;\n\n\t\t}\n\n\t\tthis._updateBoneRotation();\n\n\t\tif ( this.params.type === 1 ) {\n\n\t\t\tthis._updateBonePosition();\n\n\t\t}\n\n\t\tthis.bone.updateMatrixWorld( true );\n\n\t\tif ( this.params.type === 2 ) {\n\n\t\t\tthis._setPositionFromBone();\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t// private methods\n\n\t_init() {\n\n\t\tfunction generateShape( p ) {\n\n\t\t\tswitch ( p.shapeType ) {\n\n\t\t\t\tcase 0:\n\t\t\t\t\treturn new Ammo.btSphereShape( p.width );\n\n\t\t\t\tcase 1:\n\t\t\t\t\treturn new Ammo.btBoxShape( new Ammo.btVector3( p.width, p.height, p.depth ) );\n\n\t\t\t\tcase 2:\n\t\t\t\t\treturn new Ammo.btCapsuleShape( p.width, p.height );\n\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error( 'unknown shape type ' + p.shapeType );\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst manager = this.manager;\n\t\tconst params = this.params;\n\t\tconst bones = this.mesh.skeleton.bones;\n\t\tconst bone = ( params.boneIndex === - 1 )\n\t\t\t? new Bone()\n\t\t\t: bones[ params.boneIndex ];\n\n\t\tconst shape = generateShape( params );\n\t\tconst weight = ( params.type === 0 ) ? 0 : params.weight;\n\t\tconst localInertia = manager.allocVector3();\n\t\tlocalInertia.setValue( 0, 0, 0 );\n\n\t\tif ( weight !== 0 ) {\n\n\t\t\tshape.calculateLocalInertia( weight, localInertia );\n\n\t\t}\n\n\t\tconst boneOffsetForm = manager.allocTransform();\n\t\tmanager.setIdentity( boneOffsetForm );\n\t\tmanager.setOriginFromArray3( boneOffsetForm, params.position );\n\t\tmanager.setBasisFromArray3( boneOffsetForm, params.rotation );\n\n\t\tconst vector = manager.allocThreeVector3();\n\t\tconst boneForm = manager.allocTransform();\n\t\tmanager.setIdentity( boneForm );\n\t\tmanager.setOriginFromThreeVector3( boneForm, bone.getWorldPosition( vector ) );\n\n\t\tconst form = manager.multiplyTransforms( boneForm, boneOffsetForm );\n\t\tconst state = new Ammo.btDefaultMotionState( form );\n\n\t\tconst info = new Ammo.btRigidBodyConstructionInfo( weight, state, shape, localInertia );\n\t\tinfo.set_m_friction( params.friction );\n\t\tinfo.set_m_restitution( params.restitution );\n\n\t\tconst body = new Ammo.btRigidBody( info );\n\n\t\tif ( params.type === 0 ) {\n\n\t\t\tbody.setCollisionFlags( body.getCollisionFlags() | 2 );\n\n\t\t\t/*\n\t\t\t * It'd be better to comment out this line though in general I should call this method\n\t\t\t * because I'm not sure why but physics will be more like MMD's\n\t\t\t * if I comment out.\n\t\t\t */\n\t\t\tbody.setActivationState( 4 );\n\n\t\t}\n\n\t\tbody.setDamping( params.positionDamping, params.rotationDamping );\n\t\tbody.setSleepingThresholds( 0, 0 );\n\n\t\tthis.world.addRigidBody( body, 1 << params.groupIndex, params.groupTarget );\n\n\t\tthis.body = body;\n\t\tthis.bone = bone;\n\t\tthis.boneOffsetForm = boneOffsetForm;\n\t\tthis.boneOffsetFormInverse = manager.inverseTransform( boneOffsetForm );\n\n\t\tmanager.freeVector3( localInertia );\n\t\tmanager.freeTransform( form );\n\t\tmanager.freeTransform( boneForm );\n\t\tmanager.freeThreeVector3( vector );\n\n\t}\n\n\t_getBoneTransform() {\n\n\t\tconst manager = this.manager;\n\t\tconst p = manager.allocThreeVector3();\n\t\tconst q = manager.allocThreeQuaternion();\n\t\tconst s = manager.allocThreeVector3();\n\n\t\tthis.bone.matrixWorld.decompose( p, q, s );\n\n\t\tconst tr = manager.allocTransform();\n\t\tmanager.setOriginFromThreeVector3( tr, p );\n\t\tmanager.setBasisFromThreeQuaternion( tr, q );\n\n\t\tconst form = manager.multiplyTransforms( tr, this.boneOffsetForm );\n\n\t\tmanager.freeTransform( tr );\n\t\tmanager.freeThreeVector3( s );\n\t\tmanager.freeThreeQuaternion( q );\n\t\tmanager.freeThreeVector3( p );\n\n\t\treturn form;\n\n\t}\n\n\t_getWorldTransformForBone() {\n\n\t\tconst manager = this.manager;\n\t\tconst tr = this.body.getCenterOfMassTransform();\n\t\treturn manager.multiplyTransforms( tr, this.boneOffsetFormInverse );\n\n\t}\n\n\t_setTransformFromBone() {\n\n\t\tconst manager = this.manager;\n\t\tconst form = this._getBoneTransform();\n\n\t\t// TODO: check the most appropriate way to set\n\t\t//this.body.setWorldTransform( form );\n\t\tthis.body.setCenterOfMassTransform( form );\n\t\tthis.body.getMotionState().setWorldTransform( form );\n\n\t\tmanager.freeTransform( form );\n\n\t}\n\n\t_setPositionFromBone() {\n\n\t\tconst manager = this.manager;\n\t\tconst form = this._getBoneTransform();\n\n\t\tconst tr = manager.allocTransform();\n\t\tthis.body.getMotionState().getWorldTransform( tr );\n\t\tmanager.copyOrigin( tr, form );\n\n\t\t// TODO: check the most appropriate way to set\n\t\t//this.body.setWorldTransform( tr );\n\t\tthis.body.setCenterOfMassTransform( tr );\n\t\tthis.body.getMotionState().setWorldTransform( tr );\n\n\t\tmanager.freeTransform( tr );\n\t\tmanager.freeTransform( form );\n\n\t}\n\n\t_updateBoneRotation() {\n\n\t\tconst manager = this.manager;\n\n\t\tconst tr = this._getWorldTransformForBone();\n\t\tconst q = manager.getBasis( tr );\n\n\t\tconst thQ = manager.allocThreeQuaternion();\n\t\tconst thQ2 = manager.allocThreeQuaternion();\n\t\tconst thQ3 = manager.allocThreeQuaternion();\n\n\t\tthQ.set( q.x(), q.y(), q.z(), q.w() );\n\t\tthQ2.setFromRotationMatrix( this.bone.matrixWorld );\n\t\tthQ2.conjugate();\n\t\tthQ2.multiply( thQ );\n\n\t\t//this.bone.quaternion.multiply( thQ2 );\n\n\t\tthQ3.setFromRotationMatrix( this.bone.matrix );\n\n\t\t// Renormalizing quaternion here because repeatedly transforming\n\t\t// quaternion continuously accumulates floating point error and\n\t\t// can end up being overflow. See #15335\n\t\tthis.bone.quaternion.copy( thQ2.multiply( thQ3 ).normalize() );\n\n\t\tmanager.freeThreeQuaternion( thQ );\n\t\tmanager.freeThreeQuaternion( thQ2 );\n\t\tmanager.freeThreeQuaternion( thQ3 );\n\n\t\tmanager.freeQuaternion( q );\n\t\tmanager.freeTransform( tr );\n\n\t}\n\n\t_updateBonePosition() {\n\n\t\tconst manager = this.manager;\n\n\t\tconst tr = this._getWorldTransformForBone();\n\n\t\tconst thV = manager.allocThreeVector3();\n\n\t\tconst o = manager.getOrigin( tr );\n\t\tthV.set( o.x(), o.y(), o.z() );\n\n\t\tif ( this.bone.parent ) {\n\n\t\t\tthis.bone.parent.worldToLocal( thV );\n\n\t\t}\n\n\t\tthis.bone.position.copy( thV );\n\n\t\tmanager.freeThreeVector3( thV );\n\n\t\tmanager.freeTransform( tr );\n\n\t}\n\n}\n\n//\n\nclass Constraint {\n\n\t/**\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @param {Ammo.btDiscreteDynamicsWorld} world\n\t * @param {RigidBody} bodyA\n\t * @param {RigidBody} bodyB\n\t * @param {Object} params\n\t * @param {ResourceManager} manager\n\t */\n\tconstructor( mesh, world, bodyA, bodyB, params, manager ) {\n\n\t\tthis.mesh = mesh;\n\t\tthis.world = world;\n\t\tthis.bodyA = bodyA;\n\t\tthis.bodyB = bodyB;\n\t\tthis.params = params;\n\t\tthis.manager = manager;\n\n\t\tthis.constraint = null;\n\n\t\tthis._init();\n\n\t}\n\n\t// private method\n\n\t_init() {\n\n\t\tconst manager = this.manager;\n\t\tconst params = this.params;\n\t\tconst bodyA = this.bodyA;\n\t\tconst bodyB = this.bodyB;\n\n\t\tconst form = manager.allocTransform();\n\t\tmanager.setIdentity( form );\n\t\tmanager.setOriginFromArray3( form, params.position );\n\t\tmanager.setBasisFromArray3( form, params.rotation );\n\n\t\tconst formA = manager.allocTransform();\n\t\tconst formB = manager.allocTransform();\n\n\t\tbodyA.body.getMotionState().getWorldTransform( formA );\n\t\tbodyB.body.getMotionState().getWorldTransform( formB );\n\n\t\tconst formInverseA = manager.inverseTransform( formA );\n\t\tconst formInverseB = manager.inverseTransform( formB );\n\n\t\tconst formA2 = manager.multiplyTransforms( formInverseA, form );\n\t\tconst formB2 = manager.multiplyTransforms( formInverseB, form );\n\n\t\tconst constraint = new Ammo.btGeneric6DofSpringConstraint( bodyA.body, bodyB.body, formA2, formB2, true );\n\n\t\tconst lll = manager.allocVector3();\n\t\tconst lul = manager.allocVector3();\n\t\tconst all = manager.allocVector3();\n\t\tconst aul = manager.allocVector3();\n\n\t\tlll.setValue( params.translationLimitation1[ 0 ],\n\t\t              params.translationLimitation1[ 1 ],\n\t\t              params.translationLimitation1[ 2 ] );\n\t\tlul.setValue( params.translationLimitation2[ 0 ],\n\t\t              params.translationLimitation2[ 1 ],\n\t\t              params.translationLimitation2[ 2 ] );\n\t\tall.setValue( params.rotationLimitation1[ 0 ],\n\t\t              params.rotationLimitation1[ 1 ],\n\t\t              params.rotationLimitation1[ 2 ] );\n\t\taul.setValue( params.rotationLimitation2[ 0 ],\n\t\t              params.rotationLimitation2[ 1 ],\n\t\t              params.rotationLimitation2[ 2 ] );\n\n\t\tconstraint.setLinearLowerLimit( lll );\n\t\tconstraint.setLinearUpperLimit( lul );\n\t\tconstraint.setAngularLowerLimit( all );\n\t\tconstraint.setAngularUpperLimit( aul );\n\n\t\tfor ( let i = 0; i < 3; i ++ ) {\n\n\t\t\tif ( params.springPosition[ i ] !== 0 ) {\n\n\t\t\t\tconstraint.enableSpring( i, true );\n\t\t\t\tconstraint.setStiffness( i, params.springPosition[ i ] );\n\n\t\t\t}\n\n\t\t}\n\n\t\tfor ( let i = 0; i < 3; i ++ ) {\n\n\t\t\tif ( params.springRotation[ i ] !== 0 ) {\n\n\t\t\t\tconstraint.enableSpring( i + 3, true );\n\t\t\t\tconstraint.setStiffness( i + 3, params.springRotation[ i ] );\n\n\t\t\t}\n\n\t\t}\n\n\t\t/*\n\t\t * Currently(10/31/2016) official ammo.js doesn't support\n\t\t * btGeneric6DofSpringConstraint.setParam method.\n\t\t * You need custom ammo.js (add the method into idl) if you wanna use.\n\t\t * By setting this parameter, physics will be more like MMD's\n\t\t */\n\t\tif ( constraint.setParam !== undefined ) {\n\n\t\t\tfor ( let i = 0; i < 6; i ++ ) {\n\n\t\t\t\tconstraint.setParam( 2, 0.475, i );\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.world.addConstraint( constraint, true );\n\t\tthis.constraint = constraint;\n\n\t\tmanager.freeTransform( form );\n\t\tmanager.freeTransform( formA );\n\t\tmanager.freeTransform( formB );\n\t\tmanager.freeTransform( formInverseA );\n\t\tmanager.freeTransform( formInverseB );\n\t\tmanager.freeTransform( formA2 );\n\t\tmanager.freeTransform( formB2 );\n\t\tmanager.freeVector3( lll );\n\t\tmanager.freeVector3( lul );\n\t\tmanager.freeVector3( all );\n\t\tmanager.freeVector3( aul );\n\n\t}\n\n}\n\n//\n\nconst _position = new Vector3();\nconst _quaternion = new Quaternion();\nconst _scale = new Vector3();\nconst _matrixWorldInv = new Matrix4();\n\nclass MMDPhysicsHelper extends Object3D {\n\n\t/**\n\t * Visualize Rigid bodies\n\t *\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @param {Physics} physics\n\t */\n\tconstructor( mesh, physics ) {\n\n\t\tsuper();\n\n\t\tthis.root = mesh;\n\t\tthis.physics = physics;\n\n\t\tthis.matrix.copy( mesh.matrixWorld );\n\t\tthis.matrixAutoUpdate = false;\n\n\t\tthis.materials = [];\n\n\t\tthis.materials.push(\n\t\t\tnew MeshBasicMaterial( {\n\t\t\t\tcolor: new Color( 0xff8888 ),\n\t\t\t\twireframe: true,\n\t\t\t\tdepthTest: false,\n\t\t\t\tdepthWrite: false,\n\t\t\t\topacity: 0.25,\n\t\t\t\ttransparent: true\n\t\t\t} )\n\t\t);\n\n\t\tthis.materials.push(\n\t\t\tnew MeshBasicMaterial( {\n\t\t\t\tcolor: new Color( 0x88ff88 ),\n\t\t\t\twireframe: true,\n\t\t\t\tdepthTest: false,\n\t\t\t\tdepthWrite: false,\n\t\t\t\topacity: 0.25,\n\t\t\t\ttransparent: true\n\t\t\t} )\n\t\t);\n\n\t\tthis.materials.push(\n\t\t\tnew MeshBasicMaterial( {\n\t\t\t\tcolor: new Color( 0x8888ff ),\n\t\t\t\twireframe: true,\n\t\t\t\tdepthTest: false,\n\t\t\t\tdepthWrite: false,\n\t\t\t\topacity: 0.25,\n\t\t\t\ttransparent: true\n\t\t\t} )\n\t\t);\n\n\t\tthis._init();\n\n\t}\n\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this method whenever this instance is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tconst materials = this.materials;\n\t\tconst children = this.children;\n\n\t\tfor ( let i = 0; i < materials.length; i ++ ) {\n\n\t\t\tmaterials[ i ].dispose();\n\n\t\t}\n\n\t\tfor ( let i = 0; i < children.length; i ++ ) {\n\n\t\t\tconst child = children[ i ];\n\n\t\t\tif ( child.isMesh ) child.geometry.dispose();\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Updates Rigid Bodies visualization.\n\t */\n\tupdateMatrixWorld( force ) {\n\n\t\tvar mesh = this.root;\n\n\t\tif ( this.visible ) {\n\n\t\t\tvar bodies = this.physics.bodies;\n\n\t\t\t_matrixWorldInv\n\t\t\t\t.copy( mesh.matrixWorld )\n\t\t\t\t.decompose( _position, _quaternion, _scale )\n\t\t\t\t.compose( _position, _quaternion, _scale.set( 1, 1, 1 ) )\n\t\t\t\t.invert();\n\n\t\t\tfor ( var i = 0, il = bodies.length; i < il; i ++ ) {\n\n\t\t\t\tvar body = bodies[ i ].body;\n\t\t\t\tvar child = this.children[ i ];\n\n\t\t\t\tvar tr = body.getCenterOfMassTransform();\n\t\t\t\tvar origin = tr.getOrigin();\n\t\t\t\tvar rotation = tr.getRotation();\n\n\t\t\t\tchild.position\n\t\t\t\t\t.set( origin.x(), origin.y(), origin.z() )\n\t\t\t\t\t.applyMatrix4( _matrixWorldInv );\n\n\t\t\t\tchild.quaternion\n\t\t\t\t\t.setFromRotationMatrix( _matrixWorldInv )\n\t\t\t\t\t.multiply(\n\t\t\t\t\t\t_quaternion.set( rotation.x(), rotation.y(), rotation.z(), rotation.w() )\n\t\t\t\t\t);\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.matrix\n\t\t\t.copy( mesh.matrixWorld )\n\t\t\t.decompose( _position, _quaternion, _scale )\n\t\t\t.compose( _position, _quaternion, _scale.set( 1, 1, 1 ) );\n\n\t\tsuper.updateMatrixWorld( force );\n\n\t}\n\n\t// private method\n\n\t_init() {\n\n\t\tvar bodies = this.physics.bodies;\n\n\t\tfunction createGeometry( param ) {\n\n\t\t\tswitch ( param.shapeType ) {\n\n\t\t\t\tcase 0:\n\t\t\t\t\treturn new SphereGeometry( param.width, 16, 8 );\n\n\t\t\t\tcase 1:\n\t\t\t\t\treturn new BoxGeometry( param.width * 2, param.height * 2, param.depth * 2, 8, 8, 8 );\n\n\t\t\t\tcase 2:\n\t\t\t\t\treturn new CapsuleGeometry( param.width, param.height, 8, 16 );\n\n\t\t\t\tdefault:\n\t\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t}\n\n\t\tfor ( var i = 0, il = bodies.length; i < il; i ++ ) {\n\n\t\t\tvar param = bodies[ i ].params;\n\t\t\tthis.add( new Mesh( createGeometry( param ), this.materials[ param.type ] ) );\n\n\t\t}\n\n\t}\n\n}\n\nexport { MMDPhysics };\n", "import {\n\tAnimationMixer,\n\tObject3D,\n\tQuaternion,\n\tVector3\n} from 'three';\nimport { CCDIKSolver } from '../animation/CCDIKSolver.js';\nimport { MMDPhysics } from '../animation/MMDPhysics.js';\n\n/**\n * MMDAnimationHelper handles animation of MMD assets loaded by MMDLoader\n * with MMD special features as IK, Grant, and Physics.\n *\n * Dependencies\n *  - ammo.js https://github.com/kripken/ammo.js\n *  - MMDPhysics\n *  - CCDIKSolver\n *\n * TODO\n *  - more precise grant skinning support.\n */\nclass MMDAnimationHelper {\n\n\t/**\n\t * @param {Object} params - (optional)\n\t * @param {boolean} params.sync - Whether animation durations of added objects are synched. Default is true.\n\t * @param {Number} params.afterglow - Default is 0.0.\n\t * @param {boolean} params.resetPhysicsOnLoop - Default is true.\n\t */\n\tconstructor( params = {} ) {\n\n\t\tthis.meshes = [];\n\n\t\tthis.camera = null;\n\t\tthis.cameraTarget = new Object3D();\n\t\tthis.cameraTarget.name = 'target';\n\n\t\tthis.audio = null;\n\t\tthis.audioManager = null;\n\n\t\tthis.objects = new WeakMap();\n\n\t\tthis.configuration = {\n\t\t\tsync: params.sync !== undefined ? params.sync : true,\n\t\t\tafterglow: params.afterglow !== undefined ? params.afterglow : 0.0,\n\t\t\tresetPhysicsOnLoop: params.resetPhysicsOnLoop !== undefined ? params.resetPhysicsOnLoop : true,\n\t\t\tpmxAnimation: params.pmxAnimation !== undefined ? params.pmxAnimation : false\n\t\t};\n\n\t\tthis.enabled = {\n\t\t\tanimation: true,\n\t\t\tik: true,\n\t\t\tgrant: true,\n\t\t\tphysics: true,\n\t\t\tcameraAnimation: true\n\t\t};\n\n\t\tthis.onBeforePhysics = function ( /* mesh */ ) {};\n\n\t\t// experimental\n\t\tthis.sharedPhysics = false;\n\t\tthis.masterPhysics = null;\n\n\t}\n\n\t/**\n\t * Adds an Three.js Object to helper and setups animation.\n\t * The anmation durations of added objects are synched\n\t * if this.configuration.sync is true.\n\t *\n\t * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n\t * @param {Object} params - (optional)\n\t * @param {THREE.AnimationClip|Array<THREE.AnimationClip>} params.animation - Only for THREE.SkinnedMesh and THREE.Camera. Default is undefined.\n\t * @param {boolean} params.physics - Only for THREE.SkinnedMesh. Default is true.\n\t * @param {Integer} params.warmup - Only for THREE.SkinnedMesh and physics is true. Default is 60.\n\t * @param {Number} params.unitStep - Only for THREE.SkinnedMesh and physics is true. Default is 1 / 65.\n\t * @param {Integer} params.maxStepNum - Only for THREE.SkinnedMesh and physics is true. Default is 3.\n\t * @param {Vector3} params.gravity - Only for THREE.SkinnedMesh and physics is true. Default ( 0, - 9.8 * 10, 0 ).\n\t * @param {Number} params.delayTime - Only for THREE.Audio. Default is 0.0.\n\t * @return {MMDAnimationHelper}\n\t */\n\tadd( object, params = {} ) {\n\n\t\tif ( object.isSkinnedMesh ) {\n\n\t\t\tthis._addMesh( object, params );\n\n\t\t} else if ( object.isCamera ) {\n\n\t\t\tthis._setupCamera( object, params );\n\n\t\t} else if ( object.type === 'Audio' ) {\n\n\t\t\tthis._setupAudio( object, params );\n\n\t\t} else {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper.add: '\n\t\t\t\t+ 'accepts only '\n\t\t\t\t+ 'THREE.SkinnedMesh or '\n\t\t\t\t+ 'THREE.Camera or '\n\t\t\t\t+ 'THREE.Audio instance.' );\n\n\t\t}\n\n\t\tif ( this.configuration.sync ) this._syncDuration();\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Removes an Three.js Object from helper.\n\t *\n\t * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n\t * @return {MMDAnimationHelper}\n\t */\n\tremove( object ) {\n\n\t\tif ( object.isSkinnedMesh ) {\n\n\t\t\tthis._removeMesh( object );\n\n\t\t} else if ( object.isCamera ) {\n\n\t\t\tthis._clearCamera( object );\n\n\t\t} else if ( object.type === 'Audio' ) {\n\n\t\t\tthis._clearAudio( object );\n\n\t\t} else {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper.remove: '\n\t\t\t\t+ 'accepts only '\n\t\t\t\t+ 'THREE.SkinnedMesh or '\n\t\t\t\t+ 'THREE.Camera or '\n\t\t\t\t+ 'THREE.Audio instance.' );\n\n\t\t}\n\n\t\tif ( this.configuration.sync ) this._syncDuration();\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Updates the animation.\n\t *\n\t * @param {Number} delta\n\t * @return {MMDAnimationHelper}\n\t */\n\tupdate( delta ) {\n\n\t\tif ( this.audioManager !== null ) this.audioManager.control( delta );\n\n\t\tfor ( let i = 0; i < this.meshes.length; i ++ ) {\n\n\t\t\tthis._animateMesh( this.meshes[ i ], delta );\n\n\t\t}\n\n\t\tif ( this.sharedPhysics ) this._updateSharedPhysics( delta );\n\n\t\tif ( this.camera !== null ) this._animateCamera( this.camera, delta );\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Changes the pose of SkinnedMesh as VPD specifies.\n\t *\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @param {Object} vpd - VPD content parsed MMDParser\n\t * @param {Object} params - (optional)\n\t * @param {boolean} params.resetPose - Default is true.\n\t * @param {boolean} params.ik - Default is true.\n\t * @param {boolean} params.grant - Default is true.\n\t * @return {MMDAnimationHelper}\n\t */\n\tpose( mesh, vpd, params = {} ) {\n\n\t\tif ( params.resetPose !== false ) mesh.pose();\n\n\t\tconst bones = mesh.skeleton.bones;\n\t\tconst boneParams = vpd.bones;\n\n\t\tconst boneNameDictionary = {};\n\n\t\tfor ( let i = 0, il = bones.length; i < il; i ++ ) {\n\n\t\t\tboneNameDictionary[ bones[ i ].name ] = i;\n\n\t\t}\n\n\t\tconst vector = new Vector3();\n\t\tconst quaternion = new Quaternion();\n\n\t\tfor ( let i = 0, il = boneParams.length; i < il; i ++ ) {\n\n\t\t\tconst boneParam = boneParams[ i ];\n\t\t\tconst boneIndex = boneNameDictionary[ boneParam.name ];\n\n\t\t\tif ( boneIndex === undefined ) continue;\n\n\t\t\tconst bone = bones[ boneIndex ];\n\t\t\tbone.position.add( vector.fromArray( boneParam.translation ) );\n\t\t\tbone.quaternion.multiply( quaternion.fromArray( boneParam.quaternion ) );\n\n\t\t}\n\n\t\tmesh.updateMatrixWorld( true );\n\n\t\t// PMX animation system special path\n\t\tif ( this.configuration.pmxAnimation &&\n\t\t\tmesh.geometry.userData.MMD && mesh.geometry.userData.MMD.format === 'pmx' ) {\n\n\t\t\tconst sortedBonesData = this._sortBoneDataArray( mesh.geometry.userData.MMD.bones.slice() );\n\t\t\tconst ikSolver = params.ik !== false ? this._createCCDIKSolver( mesh ) : null;\n\t\t\tconst grantSolver = params.grant !== false ? this.createGrantSolver( mesh ) : null;\n\t\t\tthis._animatePMXMesh( mesh, sortedBonesData, ikSolver, grantSolver );\n\n\t\t} else {\n\n\t\t\tif ( params.ik !== false ) {\n\n\t\t\t\tthis._createCCDIKSolver( mesh ).update();\n\n\t\t\t}\n\n\t\t\tif ( params.grant !== false ) {\n\n\t\t\t\tthis.createGrantSolver( mesh ).update();\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Enabes/Disables an animation feature.\n\t *\n\t * @param {string} key\n\t * @param {boolean} enabled\n\t * @return {MMDAnimationHelper}\n\t */\n\tenable( key, enabled ) {\n\n\t\tif ( this.enabled[ key ] === undefined ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper.enable: '\n\t\t\t\t+ 'unknown key ' + key );\n\n\t\t}\n\n\t\tthis.enabled[ key ] = enabled;\n\n\t\tif ( key === 'physics' ) {\n\n\t\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\t\tthis._optimizeIK( this.meshes[ i ], enabled );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Creates an GrantSolver instance.\n\t *\n\t * @param {THREE.SkinnedMesh} mesh\n\t * @return {GrantSolver}\n\t */\n\tcreateGrantSolver( mesh ) {\n\n\t\treturn new GrantSolver( mesh, mesh.geometry.userData.MMD.grants );\n\n\t}\n\n\t// private methods\n\n\t_addMesh( mesh, params ) {\n\n\t\tif ( this.meshes.indexOf( mesh ) >= 0 ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._addMesh: '\n\t\t\t\t+ 'SkinnedMesh \\'' + mesh.name + '\\' has already been added.' );\n\n\t\t}\n\n\t\tthis.meshes.push( mesh );\n\t\tthis.objects.set( mesh, { looped: false } );\n\n\t\tthis._setupMeshAnimation( mesh, params.animation );\n\n\t\tif ( params.physics !== false ) {\n\n\t\t\tthis._setupMeshPhysics( mesh, params );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t_setupCamera( camera, params ) {\n\n\t\tif ( this.camera === camera ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._setupCamera: '\n\t\t\t\t+ 'Camera \\'' + camera.name + '\\' has already been set.' );\n\n\t\t}\n\n\t\tif ( this.camera ) this.clearCamera( this.camera );\n\n\t\tthis.camera = camera;\n\n\t\tcamera.add( this.cameraTarget );\n\n\t\tthis.objects.set( camera, {} );\n\n\t\tif ( params.animation !== undefined ) {\n\n\t\t\tthis._setupCameraAnimation( camera, params.animation );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t_setupAudio( audio, params ) {\n\n\t\tif ( this.audio === audio ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._setupAudio: '\n\t\t\t\t+ 'Audio \\'' + audio.name + '\\' has already been set.' );\n\n\t\t}\n\n\t\tif ( this.audio ) this.clearAudio( this.audio );\n\n\t\tthis.audio = audio;\n\t\tthis.audioManager = new AudioManager( audio, params );\n\n\t\tthis.objects.set( this.audioManager, {\n\t\t\tduration: this.audioManager.duration\n\t\t} );\n\n\t\treturn this;\n\n\t}\n\n\t_removeMesh( mesh ) {\n\n\t\tlet found = false;\n\t\tlet writeIndex = 0;\n\n\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\tif ( this.meshes[ i ] === mesh ) {\n\n\t\t\t\tthis.objects.delete( mesh );\n\t\t\t\tfound = true;\n\n\t\t\t\tcontinue;\n\n\t\t\t}\n\n\t\t\tthis.meshes[ writeIndex ++ ] = this.meshes[ i ];\n\n\t\t}\n\n\t\tif ( ! found ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._removeMesh: '\n\t\t\t\t+ 'SkinnedMesh \\'' + mesh.name + '\\' has not been added yet.' );\n\n\t\t}\n\n\t\tthis.meshes.length = writeIndex;\n\n\t\treturn this;\n\n\t}\n\n\t_clearCamera( camera ) {\n\n\t\tif ( camera !== this.camera ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._clearCamera: '\n\t\t\t\t+ 'Camera \\'' + camera.name + '\\' has not been set yet.' );\n\n\t\t}\n\n\t\tthis.camera.remove( this.cameraTarget );\n\n\t\tthis.objects.delete( this.camera );\n\t\tthis.camera = null;\n\n\t\treturn this;\n\n\t}\n\n\t_clearAudio( audio ) {\n\n\t\tif ( audio !== this.audio ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper._clearAudio: '\n\t\t\t\t+ 'Audio \\'' + audio.name + '\\' has not been set yet.' );\n\n\t\t}\n\n\t\tthis.objects.delete( this.audioManager );\n\n\t\tthis.audio = null;\n\t\tthis.audioManager = null;\n\n\t\treturn this;\n\n\t}\n\n\t_setupMeshAnimation( mesh, animation ) {\n\n\t\tconst objects = this.objects.get( mesh );\n\n\t\tif ( animation !== undefined ) {\n\n\t\t\tconst animations = Array.isArray( animation )\n\t\t\t\t? animation : [ animation ];\n\n\t\t\tobjects.mixer = new AnimationMixer( mesh );\n\n\t\t\tfor ( let i = 0, il = animations.length; i < il; i ++ ) {\n\n\t\t\t\tobjects.mixer.clipAction( animations[ i ] ).play();\n\n\t\t\t}\n\n\t\t\t// TODO: find a workaround not to access ._clip looking like a private property\n\t\t\tobjects.mixer.addEventListener( 'loop', function ( event ) {\n\n\t\t\t\tconst tracks = event.action._clip.tracks;\n\n\t\t\t\tif ( tracks.length > 0 && tracks[ 0 ].name.slice( 0, 6 ) !== '.bones' ) return;\n\n\t\t\t\tobjects.looped = true;\n\n\t\t\t} );\n\n\t\t}\n\n\t\tobjects.ikSolver = this._createCCDIKSolver( mesh );\n\t\tobjects.grantSolver = this.createGrantSolver( mesh );\n\n\t\treturn this;\n\n\t}\n\n\t_setupCameraAnimation( camera, animation ) {\n\n\t\tconst animations = Array.isArray( animation )\n\t\t\t? animation : [ animation ];\n\n\t\tconst objects = this.objects.get( camera );\n\n\t\tobjects.mixer = new AnimationMixer( camera );\n\n\t\tfor ( let i = 0, il = animations.length; i < il; i ++ ) {\n\n\t\t\tobjects.mixer.clipAction( animations[ i ] ).play();\n\n\t\t}\n\n\t}\n\n\t_setupMeshPhysics( mesh, params ) {\n\n\t\tconst objects = this.objects.get( mesh );\n\n\t\t// shared physics is experimental\n\n\t\tif ( params.world === undefined && this.sharedPhysics ) {\n\n\t\t\tconst masterPhysics = this._getMasterPhysics();\n\n\t\t\tif ( masterPhysics !== null ) world = masterPhysics.world; // eslint-disable-line no-undef\n\n\t\t}\n\n\t\tobjects.physics = this._createMMDPhysics( mesh, params );\n\n\t\tif ( objects.mixer && params.animationWarmup !== false ) {\n\n\t\t\tthis._animateMesh( mesh, 0 );\n\t\t\tobjects.physics.reset();\n\n\t\t}\n\n\t\tobjects.physics.warmup( params.warmup !== undefined ? params.warmup : 60 );\n\n\t\tthis._optimizeIK( mesh, true );\n\n\t}\n\n\t_animateMesh( mesh, delta ) {\n\n\t\tconst objects = this.objects.get( mesh );\n\n\t\tconst mixer = objects.mixer;\n\t\tconst ikSolver = objects.ikSolver;\n\t\tconst grantSolver = objects.grantSolver;\n\t\tconst physics = objects.physics;\n\t\tconst looped = objects.looped;\n\n\t\tif ( mixer && this.enabled.animation ) {\n\n\t\t\t// alternate solution to save/restore bones but less performant?\n\t\t\t//mesh.pose();\n\t\t\t//this._updatePropertyMixersBuffer( mesh );\n\n\t\t\tthis._restoreBones( mesh );\n\n\t\t\tmixer.update( delta );\n\n\t\t\tthis._saveBones( mesh );\n\n\t\t\t// PMX animation system special path\n\t\t\tif ( this.configuration.pmxAnimation &&\n\t\t\t\tmesh.geometry.userData.MMD && mesh.geometry.userData.MMD.format === 'pmx' ) {\n\n\t\t\t\tif ( ! objects.sortedBonesData ) objects.sortedBonesData = this._sortBoneDataArray( mesh.geometry.userData.MMD.bones.slice() );\n\n\t\t\t\tthis._animatePMXMesh(\n\t\t\t\t\tmesh,\n\t\t\t\t\tobjects.sortedBonesData,\n\t\t\t\t\tikSolver && this.enabled.ik ? ikSolver : null,\n\t\t\t\t\tgrantSolver && this.enabled.grant ? grantSolver : null\n\t\t\t\t);\n\n\t\t\t} else {\n\n\t\t\t\tif ( ikSolver && this.enabled.ik ) {\n\n\t\t\t\t\tmesh.updateMatrixWorld( true );\n\t\t\t\t\tikSolver.update();\n\n\t\t\t\t}\n\n\t\t\t\tif ( grantSolver && this.enabled.grant ) {\n\n\t\t\t\t\tgrantSolver.update();\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( looped === true && this.enabled.physics ) {\n\n\t\t\tif ( physics && this.configuration.resetPhysicsOnLoop ) physics.reset();\n\n\t\t\tobjects.looped = false;\n\n\t\t}\n\n\t\tif ( physics && this.enabled.physics && ! this.sharedPhysics ) {\n\n\t\t\tthis.onBeforePhysics( mesh );\n\t\t\tphysics.update( delta );\n\n\t\t}\n\n\t}\n\n\t// Sort bones in order by 1. transformationClass and 2. bone index.\n\t// In PMX animation system, bone transformations should be processed\n\t// in this order.\n\t_sortBoneDataArray( boneDataArray ) {\n\n\t\treturn boneDataArray.sort( function ( a, b ) {\n\n\t\t\tif ( a.transformationClass !== b.transformationClass ) {\n\n\t\t\t\treturn a.transformationClass - b.transformationClass;\n\n\t\t\t} else {\n\n\t\t\t\treturn a.index - b.index;\n\n\t\t\t}\n\n\t\t} );\n\n\t}\n\n\t// PMX Animation system is a bit too complex and doesn't great match to\n\t// Three.js Animation system. This method attempts to simulate it as much as\n\t// possible but doesn't perfectly simulate.\n\t// This method is more costly than the regular one so\n\t// you are recommended to set constructor parameter \"pmxAnimation: true\"\n\t// only if your PMX model animation doesn't work well.\n\t// If you need better method you would be required to write your own.\n\t_animatePMXMesh( mesh, sortedBonesData, ikSolver, grantSolver ) {\n\n\t\t_quaternionIndex = 0;\n\t\t_grantResultMap.clear();\n\n\t\tfor ( let i = 0, il = sortedBonesData.length; i < il; i ++ ) {\n\n\t\t\tupdateOne( mesh, sortedBonesData[ i ].index, ikSolver, grantSolver );\n\n\t\t}\n\n\t\tmesh.updateMatrixWorld( true );\n\t\treturn this;\n\n\t}\n\n\t_animateCamera( camera, delta ) {\n\n\t\tconst mixer = this.objects.get( camera ).mixer;\n\n\t\tif ( mixer && this.enabled.cameraAnimation ) {\n\n\t\t\tmixer.update( delta );\n\n\t\t\tcamera.updateProjectionMatrix();\n\n\t\t\tcamera.up.set( 0, 1, 0 );\n\t\t\tcamera.up.applyQuaternion( camera.quaternion );\n\t\t\tcamera.lookAt( this.cameraTarget.position );\n\n\t\t}\n\n\t}\n\n\t_optimizeIK( mesh, physicsEnabled ) {\n\n\t\tconst iks = mesh.geometry.userData.MMD.iks;\n\t\tconst bones = mesh.geometry.userData.MMD.bones;\n\n\t\tfor ( let i = 0, il = iks.length; i < il; i ++ ) {\n\n\t\t\tconst ik = iks[ i ];\n\t\t\tconst links = ik.links;\n\n\t\t\tfor ( let j = 0, jl = links.length; j < jl; j ++ ) {\n\n\t\t\t\tconst link = links[ j ];\n\n\t\t\t\tif ( physicsEnabled === true ) {\n\n\t\t\t\t\t// disable IK of the bone the corresponding rigidBody type of which is 1 or 2\n\t\t\t\t\t// because its rotation will be overriden by physics\n\t\t\t\t\tlink.enabled = bones[ link.index ].rigidBodyType > 0 ? false : true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tlink.enabled = true;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t_createCCDIKSolver( mesh ) {\n\n\t\tif ( CCDIKSolver === undefined ) {\n\n\t\t\tthrow new Error( 'THREE.MMDAnimationHelper: Import CCDIKSolver.' );\n\n\t\t}\n\n\t\treturn new CCDIKSolver( mesh, mesh.geometry.userData.MMD.iks );\n\n\t}\n\n\t_createMMDPhysics( mesh, params ) {\n\n\t\tif ( MMDPhysics === undefined ) {\n\n\t\t\tthrow new Error( 'THREE.MMDPhysics: Import MMDPhysics.' );\n\n\t\t}\n\n\t\treturn new MMDPhysics(\n\t\t\tmesh,\n\t\t\tmesh.geometry.userData.MMD.rigidBodies,\n\t\t\tmesh.geometry.userData.MMD.constraints,\n\t\t\tparams );\n\n\t}\n\n\t/*\n\t * Detects the longest duration and then sets it to them to sync.\n\t * TODO: Not to access private properties ( ._actions and ._clip )\n\t */\n\t_syncDuration() {\n\n\t\tlet max = 0.0;\n\n\t\tconst objects = this.objects;\n\t\tconst meshes = this.meshes;\n\t\tconst camera = this.camera;\n\t\tconst audioManager = this.audioManager;\n\n\t\t// get the longest duration\n\n\t\tfor ( let i = 0, il = meshes.length; i < il; i ++ ) {\n\n\t\t\tconst mixer = this.objects.get( meshes[ i ] ).mixer;\n\n\t\t\tif ( mixer === undefined ) continue;\n\n\t\t\tfor ( let j = 0; j < mixer._actions.length; j ++ ) {\n\n\t\t\t\tconst clip = mixer._actions[ j ]._clip;\n\n\t\t\t\tif ( ! objects.has( clip ) ) {\n\n\t\t\t\t\tobjects.set( clip, {\n\t\t\t\t\t\tduration: clip.duration\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t\tmax = Math.max( max, objects.get( clip ).duration );\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( camera !== null ) {\n\n\t\t\tconst mixer = this.objects.get( camera ).mixer;\n\n\t\t\tif ( mixer !== undefined ) {\n\n\t\t\t\tfor ( let i = 0, il = mixer._actions.length; i < il; i ++ ) {\n\n\t\t\t\t\tconst clip = mixer._actions[ i ]._clip;\n\n\t\t\t\t\tif ( ! objects.has( clip ) ) {\n\n\t\t\t\t\t\tobjects.set( clip, {\n\t\t\t\t\t\t\tduration: clip.duration\n\t\t\t\t\t\t} );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tmax = Math.max( max, objects.get( clip ).duration );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( audioManager !== null ) {\n\n\t\t\tmax = Math.max( max, objects.get( audioManager ).duration );\n\n\t\t}\n\n\t\tmax += this.configuration.afterglow;\n\n\t\t// update the duration\n\n\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\tconst mixer = this.objects.get( this.meshes[ i ] ).mixer;\n\n\t\t\tif ( mixer === undefined ) continue;\n\n\t\t\tfor ( let j = 0, jl = mixer._actions.length; j < jl; j ++ ) {\n\n\t\t\t\tmixer._actions[ j ]._clip.duration = max;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( camera !== null ) {\n\n\t\t\tconst mixer = this.objects.get( camera ).mixer;\n\n\t\t\tif ( mixer !== undefined ) {\n\n\t\t\t\tfor ( let i = 0, il = mixer._actions.length; i < il; i ++ ) {\n\n\t\t\t\t\tmixer._actions[ i ]._clip.duration = max;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( audioManager !== null ) {\n\n\t\t\taudioManager.duration = max;\n\n\t\t}\n\n\t}\n\n\t// workaround\n\n\t_updatePropertyMixersBuffer( mesh ) {\n\n\t\tconst mixer = this.objects.get( mesh ).mixer;\n\n\t\tconst propertyMixers = mixer._bindings;\n\t\tconst accuIndex = mixer._accuIndex;\n\n\t\tfor ( let i = 0, il = propertyMixers.length; i < il; i ++ ) {\n\n\t\t\tconst propertyMixer = propertyMixers[ i ];\n\t\t\tconst buffer = propertyMixer.buffer;\n\t\t\tconst stride = propertyMixer.valueSize;\n\t\t\tconst offset = ( accuIndex + 1 ) * stride;\n\n\t\t\tpropertyMixer.binding.getValue( buffer, offset );\n\n\t\t}\n\n\t}\n\n\t/*\n\t * Avoiding these two issues by restore/save bones before/after mixer animation.\n\t *\n\t * 1. PropertyMixer used by AnimationMixer holds cache value in .buffer.\n\t *    Calculating IK, Grant, and Physics after mixer animation can break\n\t *    the cache coherency.\n\t *\n\t * 2. Applying Grant two or more times without reset the posing breaks model.\n\t */\n\t_saveBones( mesh ) {\n\n\t\tconst objects = this.objects.get( mesh );\n\n\t\tconst bones = mesh.skeleton.bones;\n\n\t\tlet backupBones = objects.backupBones;\n\n\t\tif ( backupBones === undefined ) {\n\n\t\t\tbackupBones = new Float32Array( bones.length * 7 );\n\t\t\tobjects.backupBones = backupBones;\n\n\t\t}\n\n\t\tfor ( let i = 0, il = bones.length; i < il; i ++ ) {\n\n\t\t\tconst bone = bones[ i ];\n\t\t\tbone.position.toArray( backupBones, i * 7 );\n\t\t\tbone.quaternion.toArray( backupBones, i * 7 + 3 );\n\n\t\t}\n\n\t}\n\n\t_restoreBones( mesh ) {\n\n\t\tconst objects = this.objects.get( mesh );\n\n\t\tconst backupBones = objects.backupBones;\n\n\t\tif ( backupBones === undefined ) return;\n\n\t\tconst bones = mesh.skeleton.bones;\n\n\t\tfor ( let i = 0, il = bones.length; i < il; i ++ ) {\n\n\t\t\tconst bone = bones[ i ];\n\t\t\tbone.position.fromArray( backupBones, i * 7 );\n\t\t\tbone.quaternion.fromArray( backupBones, i * 7 + 3 );\n\n\t\t}\n\n\t}\n\n\t// experimental\n\n\t_getMasterPhysics() {\n\n\t\tif ( this.masterPhysics !== null ) return this.masterPhysics;\n\n\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\tconst physics = this.meshes[ i ].physics;\n\n\t\t\tif ( physics !== undefined && physics !== null ) {\n\n\t\t\t\tthis.masterPhysics = physics;\n\t\t\t\treturn this.masterPhysics;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn null;\n\n\t}\n\n\t_updateSharedPhysics( delta ) {\n\n\t\tif ( this.meshes.length === 0 || ! this.enabled.physics || ! this.sharedPhysics ) return;\n\n\t\tconst physics = this._getMasterPhysics();\n\n\t\tif ( physics === null ) return;\n\n\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\tconst p = this.meshes[ i ].physics;\n\n\t\t\tif ( p !== null && p !== undefined ) {\n\n\t\t\t\tp.updateRigidBodies();\n\n\t\t\t}\n\n\t\t}\n\n\t\tphysics.stepSimulation( delta );\n\n\t\tfor ( let i = 0, il = this.meshes.length; i < il; i ++ ) {\n\n\t\t\tconst p = this.meshes[ i ].physics;\n\n\t\t\tif ( p !== null && p !== undefined ) {\n\n\t\t\t\tp.updateBones();\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\n// Keep working quaternions for less GC\nconst _quaternions = [];\nlet _quaternionIndex = 0;\n\nfunction getQuaternion() {\n\n\tif ( _quaternionIndex >= _quaternions.length ) {\n\n\t\t_quaternions.push( new Quaternion() );\n\n\t}\n\n\treturn _quaternions[ _quaternionIndex ++ ];\n\n}\n\n// Save rotation whose grant and IK are already applied\n// used by grant children\nconst _grantResultMap = new Map();\n\nfunction updateOne( mesh, boneIndex, ikSolver, grantSolver ) {\n\n\tconst bones = mesh.skeleton.bones;\n\tconst bonesData = mesh.geometry.userData.MMD.bones;\n\tconst boneData = bonesData[ boneIndex ];\n\tconst bone = bones[ boneIndex ];\n\n\t// Return if already updated by being referred as a grant parent.\n\tif ( _grantResultMap.has( boneIndex ) ) return;\n\n\tconst quaternion = getQuaternion();\n\n\t// Initialize grant result here to prevent infinite loop.\n\t// If it's referred before updating with actual result later\n\t// result without applyting IK or grant is gotten\n\t// but better than composing of infinite loop.\n\t_grantResultMap.set( boneIndex, quaternion.copy( bone.quaternion ) );\n\n\t// @TODO: Support global grant and grant position\n\tif ( grantSolver && boneData.grant &&\n\t\t! boneData.grant.isLocal && boneData.grant.affectRotation ) {\n\n\t\tconst parentIndex = boneData.grant.parentIndex;\n\t\tconst ratio = boneData.grant.ratio;\n\n\t\tif ( ! _grantResultMap.has( parentIndex ) ) {\n\n\t\t\tupdateOne( mesh, parentIndex, ikSolver, grantSolver );\n\n\t\t}\n\n\t\tgrantSolver.addGrantRotation( bone, _grantResultMap.get( parentIndex ), ratio );\n\n\t}\n\n\tif ( ikSolver && boneData.ik ) {\n\n\t\t// @TODO: Updating world matrices every time solving an IK bone is\n\t\t// costly. Optimize if possible.\n\t\tmesh.updateMatrixWorld( true );\n\t\tikSolver.updateOne( boneData.ik );\n\n\t\t// No confident, but it seems the grant results with ik links should be updated?\n\t\tconst links = boneData.ik.links;\n\n\t\tfor ( let i = 0, il = links.length; i < il; i ++ ) {\n\n\t\t\tconst link = links[ i ];\n\n\t\t\tif ( link.enabled === false ) continue;\n\n\t\t\tconst linkIndex = link.index;\n\n\t\t\tif ( _grantResultMap.has( linkIndex ) ) {\n\n\t\t\t\t_grantResultMap.set( linkIndex, _grantResultMap.get( linkIndex ).copy( bones[ linkIndex ].quaternion ) );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t// Update with the actual result here\n\tquaternion.copy( bone.quaternion );\n\n}\n\n//\n\nclass AudioManager {\n\n\t/**\n\t * @param {THREE.Audio} audio\n\t * @param {Object} params - (optional)\n\t * @param {Nuumber} params.delayTime\n\t */\n\tconstructor( audio, params = {} ) {\n\n\t\tthis.audio = audio;\n\n\t\tthis.elapsedTime = 0.0;\n\t\tthis.currentTime = 0.0;\n\t\tthis.delayTime = params.delayTime !== undefined\n\t\t\t? params.delayTime : 0.0;\n\n\t\tthis.audioDuration = this.audio.buffer.duration;\n\t\tthis.duration = this.audioDuration + this.delayTime;\n\n\t}\n\n\t/**\n\t * @param {Number} delta\n\t * @return {AudioManager}\n\t */\n\tcontrol( delta ) {\n\n\t\tthis.elapsed += delta;\n\t\tthis.currentTime += delta;\n\n\t\tif ( this._shouldStopAudio() ) this.audio.stop();\n\t\tif ( this._shouldStartAudio() ) this.audio.play();\n\n\t\treturn this;\n\n\t}\n\n\t// private methods\n\n\t_shouldStartAudio() {\n\n\t\tif ( this.audio.isPlaying ) return false;\n\n\t\twhile ( this.currentTime >= this.duration ) {\n\n\t\t\tthis.currentTime -= this.duration;\n\n\t\t}\n\n\t\tif ( this.currentTime < this.delayTime ) return false;\n\n\t\t// 'duration' can be bigger than 'audioDuration + delayTime' because of sync configuration\n\t\tif ( ( this.currentTime - this.delayTime ) > this.audioDuration ) return false;\n\n\t\treturn true;\n\n\t}\n\n\t_shouldStopAudio() {\n\n\t\treturn this.audio.isPlaying &&\n\t\t\tthis.currentTime >= this.duration;\n\n\t}\n\n}\n\nconst _q = new Quaternion();\n\n/**\n * Solver for Grant (Fuyo in Japanese. I just google translated because\n * Fuyo may be MMD specific term and may not be common word in 3D CG terms.)\n * Grant propagates a bone's transform to other bones transforms even if\n * they are not children.\n * @param {THREE.SkinnedMesh} mesh\n * @param {Array<Object>} grants\n */\nclass GrantSolver {\n\n\tconstructor( mesh, grants = [] ) {\n\n\t\tthis.mesh = mesh;\n\t\tthis.grants = grants;\n\n\t}\n\n\t/**\n\t * Solve all the grant bones\n\t * @return {GrantSolver}\n\t */\n\tupdate() {\n\n\t\tconst grants = this.grants;\n\n\t\tfor ( let i = 0, il = grants.length; i < il; i ++ ) {\n\n\t\t\tthis.updateOne( grants[ i ] );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Solve a grant bone\n\t * @param {Object} grant - grant parameter\n\t * @return {GrantSolver}\n\t */\n\tupdateOne( grant ) {\n\n\t\tconst bones = this.mesh.skeleton.bones;\n\t\tconst bone = bones[ grant.index ];\n\t\tconst parentBone = bones[ grant.parentIndex ];\n\n\t\tif ( grant.isLocal ) {\n\n\t\t\t// TODO: implement\n\t\t\tif ( grant.affectPosition ) {\n\n\t\t\t}\n\n\t\t\t// TODO: implement\n\t\t\tif ( grant.affectRotation ) {\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\t// TODO: implement\n\t\t\tif ( grant.affectPosition ) {\n\n\t\t\t}\n\n\t\t\tif ( grant.affectRotation ) {\n\n\t\t\t\tthis.addGrantRotation( bone, parentBone.quaternion, grant.ratio );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\taddGrantRotation( bone, q, ratio ) {\n\n\t\t_q.set( 0, 0, 0, 1 );\n\t\t_q.slerp( q, ratio );\n\t\tbone.quaternion.multiply( _q );\n\n\t\treturn this;\n\n\t}\n\n}\n\nexport { MMDAnimationHelper };\n"],
  "mappings": "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",
  "names": ["world", "param", "_q"]
}
